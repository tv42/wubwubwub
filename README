Twisted.Web Debian Package
==========================

Our Motto: Making Twisted.Web look like Apache since 2002

This file documents the specific configuration framework used for the
Debian package of Twisted.Web. For non-trivial options which are not
covered here, be sure to read
/usr/share/doc/twisted-doc/howto/using-twistedweb.xhtml 
(in the "twisted-doc" package).

Explanation of Default Configuration
------------------------------------

The default configuration's goals are the following, in this order

* Maximum safety - Always err on side of locking down too much, and let the
  user open up options of dubious safety.
* Maximum familiarity - If the choices don't present any inherent danger,
  configure to be as similar to the standard web server configuration. The
  Apache configuration being the most thorough is the reason for the motto.
* Maximum flexibility - As long as it is not unsafe nor too surprising, try
  to have a configuration which lends as much power to the end user.

The user it runs as (after binding to ports) is www-data, and the
group is also www-data.

By default, the configuration is to handle all hostnames to be the same --
all pointing to /var/www. No "processors" are enabled, so it is possible
to allow untrusted parties to put files in /var/www without giving them
the ability to run code as www-data. 

/doc is pointed to /usr/share/doc/, so all the Debian documentation is
served by default (which means, for example, dhelp works).

/cgi-bin is pointed to /usr/lib/cgi-bin/, so third-party packages CGI
(mailman, man2html) are likewise served.

/users/<name>/ points to the user's public_html directory.

/users/<name>.twistd/ will relay requests to the user personal server,
if it exists.

/~name/, or /~name.twistd/, function the same as /users/name/ or
/users/name.twistd/.

Any documents with unrecognised extension are served as text/html.

Modifications and Smooth Upgrades
---------------------------------

In order to avoid modifying the configuration files so maintainer updates
can happen smoothly, please put local configuration files in
/etc/twisted-web/local.d
All .py files in this directory are evaluated according to lexical order.
It is recommended files will begin with two digits to set the order.
All example drop-in configuration files follow this convention.   

Drop-in configuration files are evaluated inside a namespace consisting
of 
- root -- the root resource, usually a NameVirtualHost
- default -- the default File root for names which are not virtual hosts
- site -- a web.server.Site, the factory
- application -- a twisted.internet.app.Application

Examples of such configuration scripts are in
/usr/share/doc/twisted-doc/examples
Note: Do *not* copy all scripts blindly. Some are positively dangerous,
and some need to be tweaked before used. Please read the comments in
each example before using it.

Note that the examples use the convention of prefixing every script name
by two decimal digits. This convention, together with the fact that
the scripts are read in lexicographical order, allows the order of
evaluation to be easily seen (and modified, if so desired).

Ports
-----

Since ports are often needed to be modified by programs, the port list
is kept in /etc/twisted-web/ports for HTTP ports and /etc/twisted-web/ssl-ports
for ports served via HTTPS. The code which is responsible for listening
on them is in /etc/twisted-web/twisted-web, so it is possible to disable
it. Note, however, that programs such as rptwisted (described below) depend
on this configuration, and may not work effectively if it is disabled.

Note that if you enable any of the ssl-ports, you should install
python2.2-pyopenssl for them to work correctly.

Conffiles
---------

In case you do want to modify the package's conffiles, note that they
have been paritioned into logical pieces. /etc/twisted-web/twisted-web
is the master configuration, which loads all others. It should rarely,
if ever, be modified.

The configuration loads the following files:
- /etc/twisted-web/default: create the default web site
- /etc/twisted-web/root: create the root site (as a virtual hosted site)
- /etc/twisted-web/site: create the Site factory
- /etc/twisted-web/application: create the application object, listen on ports
- /etc/twisted-web/directories: read the scripts inside
                                /etc/twisted-web/package.d and
                                /etc/twisted-web/local.d

Dynamic User Pages
------------------

A user who wants dynamic pages should somehow make sure a personal server is
up and running. The easiest way to do this is to use the mktap web command
with the --personal argument, and then start the server with
'''
twistd2.2 -f ~/web.tap
'''

Starting servers can be done with crontab and a line like:
'''
@reboot cd $HOME;twistd2.2 -f ~/web.tap
'''

Reverse Proxy Configuration
---------------------------

If some other program is running on port 80 Twisted-Web will be disabled until
you change /etc/twisted-web/disable to be empty. You should do this after
changing the configuration of Twisted-Web to listen on some other port, or
changing the configuration of the other server. After undisabling Twisted-Web,
run the command "invoke-rc.d twisted-web" to start the server manually.

rptwisted exists to run Twisted on an out-of-the-way port and prepare it
to be a reverse proxy.  It will reconfigure Twisted-Web to run on another
port, and will also, optionally, drop a file in Apache2's configuration
directory to reverse proxy a named virtual host to the Twisted-Web server.

Running rptwisted without Apache 2 support:
rptwisted --port=8777

Running rptwisted with Apache 2 support:
rptwisted --port=8777 --vhost=twisted.example.com --apache-port=80

If you don't use the option to generate the Apache2 virtual host configuration,
or if you want to add more virtual host configurations, here is the template
for a file to drop in /etc/apache2/sites-available:

'''
<VirtualHost *>
ProxyPass / http://localhost:8538/vhost/http/example.com:80/
ServerName example.com
</VirtualHost>
'''

Remember to symlink it to sites-enabled, and restart Apache2!


Packages Containing Resources
-----------------------------

/usr/lib/rpy-lib is served as a ResourceScriptDirectory -- anything in
it is assumed to be a ResourceScript, and will be served as such.
If your package has a Resource it wants to serve, Depend: on twisted-web,
and drop your ResourceScript (which does *not* have to be named .rpy)
in /usr/lib/rpy-lib. In particular if your package wants to serve a portion
of the web site, perhaps as a different user, use ResourcePublisher to
listen on a socket somewhere on /var/run, and have a ResourceSubscriber
in a ResourceScript which is then dropped in /usr/lib/rpy-lib. It is
possible to cache the ResourceSubscriber in the registry. For more
information about writing resources, see the using-twistedweb.xhtml document
in twisted-doc. Note that starting and stopping your server is still
your responsibility.


Packages Wanting to Modify the Configuration
--------------------------------------------

/etc/twisted-web/package.d is designed for packages to drop in their
configurations. For example, a package installing itself in a non-standard
location may use this to add its directory to sys.path.


Purging Twisted-Web
-------------------

Note that files in /etc/twisted-web/local.d are *not* deleted as part
of the purge. These file are the system administrator's creations.
If you want to get rid of them, run
rm -f /etc/twisted-web/local.d/*


Checking Configuration
----------------------

When the configuration changes, it is highly recommended to run
"twconfcheck". This program, which can be run as a regular user,
will execute the configuration and check the application object
for simple mistakes. This will increase signifcantly that a
"invoke-rc.d twisted-web restart" will succeed.
