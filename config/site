from nevow import appserver
from twisted.protocols import http

# This is the *Apache compatible* log file, not the twisted-style logfile.
# Leaving this as None will have no Apache compatible log file. Apache
# compatible logfiles are useful because there are quite a few programs
# which analyse them and display statistics. 
logPath = '/var/log/twisted-web/access.log'

# Generate the Site factory. You will not normally
# want to modify this line.
site = appserver.NevowSite(root, logPath=logPath)

class VhostLoggingNevowSite(appserver.NevowSite):
    def log(self, request):
        """Log a request's result to the logfile, in combined log format prefixed with virtual host name."""
        if hasattr(self, "logFile"):
            line = '%r %s - - %s "%s" %d %s "%s" "%s"\n' % (
                request.getHeader('host'),
                request.getClientIP(),
                # request.getUser() or "-", # the remote user is almost never important
                http._logDateTime,
                '%s %s %s' % (request.method, request.uri, request.clientproto),
                request.code,
                request.sentLength or "-",
                request.getHeader("referer") or "-",
                request.getHeader("user-agent") or "-")
            self.logFile.write(line)

site = VhostLoggingNevowSite(root, logPath=logPath)
