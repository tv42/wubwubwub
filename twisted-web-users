from twisted.internet import app
from twisted.runner import procmon
import os, pwd

if os.path.exists("/etc/twisted-web/twisted-web-users.allow"):
    users = open("/etc/twisted-web/twisted-web-users.allow").read().split()
else:
    users = [entry[0] for entry in pwd.getpwall()]

if os.path.exists("/etc/twisted-web/twisted-web-users.deny"):
    denied = open("/etc/twisted-web/twisted-web-users.deny").read().split()
    for user in denied:
        try:
            users.remove(user)
        except ValueError:
            pass

commands = [(entry[0], ['/bin/sh', '-c', 'cd %s;./.twisted-command' % entry[5]],
            entry[2], entry[3]) for entry in map(pwd.getpwnam, users)
                           if entry[2]>=1000 and entry[0]!='nobody' and
                              os.path.isfile(entry[5]+'/.twisted-command')]

application = app.Application("twisted-web-users", 0, 0)

processMonitor = procmon.ProcessMonitor("personal-servers", application)

for command in commands:
    processMonitor.addProcess(*command)
